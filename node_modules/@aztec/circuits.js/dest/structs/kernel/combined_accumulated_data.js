import { makeTuple } from '@aztec/foundation/array';
import { arraySerializedSizeOfNonEmpty } from '@aztec/foundation/collection';
import { Fr } from '@aztec/foundation/fields';
import { BufferReader, serializeToBuffer } from '@aztec/foundation/serialize';
import { inspect } from 'util';
import { MAX_ENCRYPTED_LOGS_PER_TX, MAX_L2_TO_L1_MSGS_PER_TX, MAX_NOTE_ENCRYPTED_LOGS_PER_TX, MAX_NOTE_HASHES_PER_TX, MAX_NULLIFIERS_PER_TX, MAX_PUBLIC_DATA_UPDATE_REQUESTS_PER_TX, MAX_UNENCRYPTED_LOGS_PER_TX, } from '../../constants.gen.js';
import { Gas } from '../gas.js';
import { ScopedL2ToL1Message } from '../l2_to_l1_message.js';
import { LogHash, ScopedLogHash } from '../log_hash.js';
import { PublicDataUpdateRequest } from '../public_data_update_request.js';
/**
 * Data that is accumulated during the execution of the transaction.
 */
export class CombinedAccumulatedData {
    constructor(
    /**
     * The new note hashes made in this transaction.
     */
    noteHashes, 
    /**
     * The new nullifiers made in this transaction.
     */
    nullifiers, 
    /**
     * All the new L2 to L1 messages created in this transaction.
     */
    l2ToL1Msgs, 
    /**
     * Accumulated note logs hashes from all the previous kernel iterations.
     */
    noteEncryptedLogsHashes, 
    /**
     * Accumulated encrypted logs hashes from all the previous kernel iterations.
     */
    encryptedLogsHashes, 
    /**
     * Accumulated unencrypted logs hash from all the previous kernel iterations.
     * Note: Truncated to 31 bytes to fit in Fr.
     */
    unencryptedLogsHashes, 
    /**
     * Total accumulated length of the encrypted note log preimages emitted in all the previous kernel iterations
     */
    noteEncryptedLogPreimagesLength, 
    /**
     * Total accumulated length of the encrypted log preimages emitted in all the previous kernel iterations
     */
    encryptedLogPreimagesLength, 
    /**
     * Total accumulated length of the unencrypted log preimages emitted in all the previous kernel iterations
     */
    unencryptedLogPreimagesLength, 
    /**
     * All the public data update requests made in this transaction.
     */
    publicDataUpdateRequests, 
    /** Gas used during this transaction */
    gasUsed) {
        this.noteHashes = noteHashes;
        this.nullifiers = nullifiers;
        this.l2ToL1Msgs = l2ToL1Msgs;
        this.noteEncryptedLogsHashes = noteEncryptedLogsHashes;
        this.encryptedLogsHashes = encryptedLogsHashes;
        this.unencryptedLogsHashes = unencryptedLogsHashes;
        this.noteEncryptedLogPreimagesLength = noteEncryptedLogPreimagesLength;
        this.encryptedLogPreimagesLength = encryptedLogPreimagesLength;
        this.unencryptedLogPreimagesLength = unencryptedLogPreimagesLength;
        this.publicDataUpdateRequests = publicDataUpdateRequests;
        this.gasUsed = gasUsed;
    }
    getSize() {
        return (arraySerializedSizeOfNonEmpty(this.noteHashes) +
            arraySerializedSizeOfNonEmpty(this.nullifiers) +
            arraySerializedSizeOfNonEmpty(this.l2ToL1Msgs) +
            arraySerializedSizeOfNonEmpty(this.noteEncryptedLogsHashes) +
            arraySerializedSizeOfNonEmpty(this.encryptedLogsHashes) +
            arraySerializedSizeOfNonEmpty(this.unencryptedLogsHashes) +
            this.noteEncryptedLogPreimagesLength.size +
            this.encryptedLogPreimagesLength.size +
            this.unencryptedLogPreimagesLength.size +
            arraySerializedSizeOfNonEmpty(this.publicDataUpdateRequests) +
            this.gasUsed.toBuffer().length);
    }
    static getFields(fields) {
        return [
            fields.noteHashes,
            fields.nullifiers,
            fields.l2ToL1Msgs,
            fields.noteEncryptedLogsHashes,
            fields.encryptedLogsHashes,
            fields.unencryptedLogsHashes,
            fields.noteEncryptedLogPreimagesLength,
            fields.encryptedLogPreimagesLength,
            fields.unencryptedLogPreimagesLength,
            fields.publicDataUpdateRequests,
            fields.gasUsed,
        ];
    }
    static from(fields) {
        return new CombinedAccumulatedData(...CombinedAccumulatedData.getFields(fields));
    }
    toBuffer() {
        return serializeToBuffer(...CombinedAccumulatedData.getFields(this));
    }
    toString() {
        return this.toBuffer().toString('hex');
    }
    /**
     * Deserializes from a buffer or reader, corresponding to a write in cpp.
     * @param buffer - Buffer or reader to read from.
     * @returns Deserialized object.
     */
    static fromBuffer(buffer) {
        const reader = BufferReader.asReader(buffer);
        return new CombinedAccumulatedData(reader.readArray(MAX_NOTE_HASHES_PER_TX, Fr), reader.readArray(MAX_NULLIFIERS_PER_TX, Fr), reader.readArray(MAX_L2_TO_L1_MSGS_PER_TX, ScopedL2ToL1Message), reader.readArray(MAX_NOTE_ENCRYPTED_LOGS_PER_TX, LogHash), reader.readArray(MAX_ENCRYPTED_LOGS_PER_TX, ScopedLogHash), reader.readArray(MAX_UNENCRYPTED_LOGS_PER_TX, ScopedLogHash), Fr.fromBuffer(reader), Fr.fromBuffer(reader), Fr.fromBuffer(reader), reader.readArray(MAX_PUBLIC_DATA_UPDATE_REQUESTS_PER_TX, PublicDataUpdateRequest), reader.readObject(Gas));
    }
    /**
     * Deserializes from a string, corresponding to a write in cpp.
     * @param str - String to read from.
     * @returns Deserialized object.
     */
    static fromString(str) {
        return CombinedAccumulatedData.fromBuffer(Buffer.from(str, 'hex'));
    }
    static empty() {
        return new CombinedAccumulatedData(makeTuple(MAX_NOTE_HASHES_PER_TX, Fr.zero), makeTuple(MAX_NULLIFIERS_PER_TX, Fr.zero), makeTuple(MAX_L2_TO_L1_MSGS_PER_TX, ScopedL2ToL1Message.empty), makeTuple(MAX_NOTE_ENCRYPTED_LOGS_PER_TX, LogHash.empty), makeTuple(MAX_ENCRYPTED_LOGS_PER_TX, ScopedLogHash.empty), makeTuple(MAX_UNENCRYPTED_LOGS_PER_TX, ScopedLogHash.empty), Fr.zero(), Fr.zero(), Fr.zero(), makeTuple(MAX_PUBLIC_DATA_UPDATE_REQUESTS_PER_TX, PublicDataUpdateRequest.empty), Gas.empty());
    }
    [inspect.custom]() {
        return `CombinedAccumulatedData {
      noteHashes: [${this.noteHashes
            .filter(x => !x.isZero())
            .map(x => inspect(x))
            .join(', ')}],
      nullifiers: [${this.nullifiers
            .filter(x => !x.isZero())
            .map(x => inspect(x))
            .join(', ')}],
      l2ToL1Msgs: [${this.l2ToL1Msgs
            .filter(x => !x.isEmpty())
            .map(x => inspect(x))
            .join(', ')}],
      noteEncryptedLogsHash:  [${this.noteEncryptedLogsHashes
            .filter(x => !x.isEmpty())
            .map(x => inspect(x))
            .join(', ')}]
      encryptedLogsHash: [${this.encryptedLogsHashes
            .filter(x => !x.isEmpty())
            .map(x => inspect(x))
            .join(', ')}]
      unencryptedLogsHashes: : [${this.unencryptedLogsHashes
            .filter(x => !x.isEmpty())
            .map(x => inspect(x))
            .join(', ')}],
      noteEncryptedLogPreimagesLength: ${this.noteEncryptedLogPreimagesLength.toString()},
      encryptedLogPreimagesLength: ${this.encryptedLogPreimagesLength.toString()},
      unencryptedLogPreimagesLength: ${this.unencryptedLogPreimagesLength.toString()},
      publicDataUpdateRequests: [${this.publicDataUpdateRequests
            .filter(x => !x.isEmpty())
            .map(x => inspect(x))
            .join(', ')}],
      gasUsed: ${inspect(this.gasUsed)}
    }`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYmluZWRfYWNjdW11bGF0ZWRfZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdHJ1Y3RzL2tlcm5lbC9jb21iaW5lZF9hY2N1bXVsYXRlZF9kYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDbkUsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQWMsaUJBQWlCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUxRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFDTCx5QkFBeUIsRUFDekIsd0JBQXdCLEVBQ3hCLDhCQUE4QixFQUM5QixzQkFBc0IsRUFDdEIscUJBQXFCLEVBQ3JCLHNDQUFzQyxFQUN0QywyQkFBMkIsR0FDNUIsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzdELE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFM0U7O0dBRUc7QUFDSCxNQUFNLE9BQU8sdUJBQXVCO0lBQ2xDO0lBQ0U7O09BRUc7SUFDSSxVQUFvRDtJQUMzRDs7T0FFRztJQUNJLFVBQW1EO0lBQzFEOztPQUVHO0lBQ0ksVUFBdUU7SUFDOUU7O09BRUc7SUFDSSx1QkFBOEU7SUFDckY7O09BRUc7SUFDSSxtQkFBMkU7SUFDbEY7OztPQUdHO0lBQ0kscUJBQStFO0lBQ3RGOztPQUVHO0lBQ0ksK0JBQW1D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